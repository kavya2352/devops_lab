pipeline {
  agent any

  environment {
    DOCKERHUB_USER = 'kavyak2305'
    DOCKERHUB_EMAIL = 'kavyakuthala2305@gmail.com'
    IMAGE_NAME = 'quiz-app'
  }

  stages {

    stage('Clone Repository') {
      steps {
        git 'https://github.com/kavya2352/devops_lab.git'
      }
    }

    stage('Build Docker Image') {
      steps {
        sh '''
          cd QUIZ-APP
          docker build -t ${DOCKERHUB_USER}/${IMAGE_NAME}:latest .
        '''
      }
    }

    stage('Push to DockerHub') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
          sh '''
            echo $PASS | docker login -u $USER --password-stdin
            docker push ${DOCKERHUB_USER}/${IMAGE_NAME}:latest
          '''
        }
      }
    }

    stage('Update Deployment File') {
      environment {
        GIT_REPO_NAME = "devops_app"
        GIT_USER_NAME = "kavya2352"
      }
      steps {
        withCredentials([string(credentialsId: 'github', variable: 'GITHUB_TOKEN')]) {
          sh '''
            git config user.email "kavyakuthala27@gmail.com"
            git config user.name "kavya2352"
            sed -i "s|image:.*|image: ${DOCKERHUB_USER}/${IMAGE_NAME}:${BUILD_NUMBER}|g" QUIZ-APP/kubernetes/deployment.yml
            git add QUIZ-APP/kubernetes/deployment.yml
            git commit -m "Update image to version ${BUILD_NUMBER}"
            git push https://${GITHUB_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git HEAD:main
          '''
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        sh '''
          kubectl apply -f QUIZ-APP/kubernetes/deployment.yml
          kubectl apply -f QUIZ-APP/kubernetes/service.yml
        '''
      }
    }
  }
}
